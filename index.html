<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./leaflet/leaflet.css">
    <script src="./leaflet/leaflet.js"></script>
    <title>Map Test</title>
    <style>
        body{
            margin: 0;
            overflow: hidden;
        }
        #map{
            width: 100vw;
            height: 100vh;
        }

    </style>
</head>
<body>
          <div id="map" style="position: absolute;"></div>
        
       <script>
               // Create a map object and specify the DOM element for display.
               var target = document.querySelector("#map")

               if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showMap);
                } else {
                    target.innerHTML = `<h1 style="padding-top:${screen.height/2.5}px; text-align:center;">No Geolocation Support</h1>`
                    }

                    function showMap(position) {
                    var x = [position.coords.latitude, position.coords.longitude];
                    var accuracy = position.coords.accuracy
                    console.log(accuracy)
                    initMap(x, accuracy)
                    }

                async function getLocName(e) {
                    return await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${e.latlng.lat}&longitude=${e.latlng.lng}&localityLanguage=id`)
                        .then(response => response.json())
                        .then(data => {return data});
                    
                }

                async function setMark(e) {
                    let loc = await getLocName(e)
                    var l
                    if (loc.city==''){
                         l = `${loc.locality} - ${loc.countryName}`
                    }
                    else{
                         l = `${loc.city}, ${loc.locality} - ${loc.countryName}`
                    }
                    return L.marker(e.latlng, {title: l }).bindPopup(`<b>${l}</b>`)
                }

               function initMap(loc,acc){
                   console.log(loc)
               var map = L.map(target, {
                    center: loc,
                    zoom: 16
                });

                async function addMarker(e) {
                    let x = await setMark(e)
                    x.addTo(map).on('contextmenu', function(e){map.removeLayer(this); map.flyTo(currentLoc._latlng, 16);})
                    x.addTo(map).on('click', function(e){map.flyTo(e.latlng); this.openPopup();})
                    map.flyTo(e.latlng, 16)
                    return x.openPopup()
                }

                var currentLoc = L.circle(loc, {color:'#0022ff', fillColor:'#00ccff', fillOpacity:1, radius:100}).bindPopup("<b>You Are Here</b>")

                var approx = L.circle(loc,{color:'red', fillColor:'#0099ff', fillOpacity:0.2, radius:acc}).addTo(map)

                currentLoc.on('click', function(e){map.flyTo(e.latlng); this.openPopup()})
                currentLoc.addTo(map);

                L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                }).addTo(map);

                map.on('click', addMarker)
               }
     
       </script>
       
    
</body>
</html>